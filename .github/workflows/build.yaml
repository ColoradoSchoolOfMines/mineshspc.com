name: "Build and Deploy"

on:
  push:

env:
  HOST: morak.sumnerevans.com
  GHCR_REGISTRY: ghcr.io
  GHCR_REGISTRY_IMAGE: "ghcr.io/coloradoschoolofmines/mineshspc.com"

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-go@v3
        with:
          go-version-file: "go.mod"
          cache: true

      - name: Install dependencies
        run: |
          go install golang.org/x/tools/cmd/goimports@latest
          go install honnef.co/go/tools/cmd/staticcheck@v0.3.3
          export PATH="$HOME/go/bin:$PATH"

      - name: Run pre-commit
        uses: pre-commit/action@v3.0.0

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-go@v3
        with:
          go-version-file: "go.mod"
          cache: true

      - run: go build

      - uses: actions/upload-artifact@v3
        with:
          name: mineshspc.com
          path: mineshspc.com

  build-docker:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Login to ghcr
        if: github.ref == 'refs/heads/master'
        uses: docker/login-action@v2
        with:
          registry: ${{ env.GHCR_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker Build
        uses: docker/build-push-action@v4
        with:
          context: .
          cache-from: ${{ env.GHCR_REGISTRY_IMAGE }}:latest
          pull: true
          file: Dockerfile
          tags: ${{ env.GHCR_REGISTRY_IMAGE }}:${{ github.sha }}
          push: ${{ github.ref == 'refs/heads/master' }}

  deploy-docker:
    runs-on: ubuntu-latest
    needs:
      - lint
      - build-docker
    if: github.ref == 'refs/heads/master'
    steps:
      - name: Login to ghcr
        uses: docker/login-action@v2
        with:
          registry: ${{ env.GHCR_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - uses: beeper/docker-retag-push-latest@main
        with:
          image: ${{ env.GHCR_REGISTRY_IMAGE }}

  submit-hash-update-pr:
    runs-on: ubuntu-latest
    needs:
      - lint
      - build-docker
    if: github.ref == 'refs/heads/master'
    steps:
      - uses: actions/checkout@v3
        with:
          repository: nevarro-space/infrastructure

      - name: Edit the hash
        run: |
          sed 's|"${{ env.GHCR_REGISTRY_IMAGE }}:.*"|"${{ env.GHCR_REGISTRY_IMAGE }}:${{ github.sha }}"|g' flake.nix
          sed -i 's|"${{ env.GHCR_REGISTRY_IMAGE }}:.*"|"${{ env.GHCR_REGISTRY_IMAGE }}:${{ github.sha }}"|g' flake.nix

      - name: Create PR against Nevarro's infrastructure repository
        id: cpr
        uses: peter-evans/create-pull-request@v4
        with:
          token: ${{ secrets.PR_CREATOR_TOKEN }}
          commit-message: "mineshspc.com: update to ${{ github.sha }}"
          title: "mineshspc.com: update to ${{ github.sha }}"
          body: |
            Automated changes by [create-pull-request](https://github.com/peter-evans/create-pull-request) GitHub action in the [mineshspc.com](https://github.com/ColoradoSchoolOfMines/mineshspc.com) repository.

            **Changes:** https://github.com/ColoradoSchoolOfMines/mineshspc.com/commits/${{ github.sha }}
          branch: update-mineshspc
          delete-branch: true
          assignees: sumnerevans

      - name: Check outputs
        if: ${{ steps.cpr.outputs.pull-request-number }}
        run: |
          echo "Pull Request Number - ${{ steps.cpr.outputs.pull-request-number }}"
          echo "Pull Request URL - ${{ steps.cpr.outputs.pull-request-url }}"
